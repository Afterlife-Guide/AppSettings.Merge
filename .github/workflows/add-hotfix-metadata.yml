name: DAdd HotFix Metadata

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - master
  workflow_dispatch:

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  get-version:
    if: startsWith(github.head_ref, 'hotfix/')
    uses: ./.github/workflows/step-version.yml
    
  update-metadata:
    if: github.event.action == 'opened'
    needs: [get-version]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      - name: Checkout head branch
        env:
          HEAD_REF: ${{ github.head_ref }}
        run: |
          # Validate that HEAD_REF is a valid git reference
          if ! git check-ref-format --allow-onelevel "$HEAD_REF"; then
            echo "Error: Invalid branch name format"
            exit 1
          fi
          git fetch origin "$HEAD_REF"
          git checkout "$HEAD_REF"
      - name: Increment Version
        id: increment_version
        run: |
          echo "patch_version=$(($(cat semver.json | jq -r '.patch')+1))" >> $GITHUB_OUTPUT
      - name: Store New Version
        uses: Afterlife-Guide/SemVer.Action@9dc4921011b4c29d63259b6bbd6d7322410e2e91
        with:
          path: semver.json
          major-version: ${{ needs.get-version.outputs.major }}
          minor-version: ${{ needs.get-version.outputs.minor }}
          patch-version: ${{ steps.increment_version.outputs.patch_version }}
          build-version: ${{ github.run_number }}
      - name: Update changelog
        uses: baynezy/ChangeLogger.Action@f714b7a6bcb0610dedb551cdc16a5adc0a775972
        with:
          tag: ${{ needs.get-version.outputs.major }}.${{ needs.get-version.outputs.minor }}.${{ steps.increment_version.outputs.patch_version }}.${{ github.run_number }}

      - name: Update docker image tag version in action.yml
        env:
          MAJOR_VERSION: ${{ needs.get-version.outputs.major }}
          MINOR_VERSION: ${{ needs.get-version.outputs.minor }}
          PATCH_VERSION: ${{ steps.increment_version.outputs.patch_version }}
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          sed -i "s/image: 'docker:\/\/ghcr.io\/afterlife-guide\/appsettings.merge:.*/image: 'docker:\/\/ghcr.io\/afterlife-guide\/appsettings.merge:$MAJOR_VERSION.$MINOR_VERSION.$PATCH_VERSION.$RUN_NUMBER'/" action.yml
      
      - name: Commit Changes
        env:
          MAJOR_VERSION: ${{ needs.get-version.outputs.major }}
          MINOR_VERSION: ${{ needs.get-version.outputs.minor }}
          PATCH_VERSION: ${{ steps.increment_version.outputs.patch_version }}
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "no-reply@after-life.co"
          git add CHANGELOG.md semver.json action.yml
          git commit --message "Bump Version to $MAJOR_VERSION.$MINOR_VERSION.$PATCH_VERSION.$RUN_NUMBER"

      - name: Push Version
        env:
          BRANCH_NAME: ${{ github.head_ref }}
        run: git push origin "$BRANCH_NAME"