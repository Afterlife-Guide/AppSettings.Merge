name: "Draft new production release"

on:
  workflow_dispatch:
    inputs:
      major_version:
        description: 'The major version you want to release.'
        required: true
      minor_version:
        description: 'The minor version you want to release.'
        required: true
      patch_version:
        description: 'The patch version you want to release.'
        required: true

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:

  draft-new-release:
    name: "Draft a new release"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          token: ${{ secrets.CREATE_PR_TOKEN }}
          fetch-depth: 0
      - name: Validate and store version inputs
        id: validate-version
        env:
          MAJOR_VERSION: ${{ github.event.inputs.major_version }}
          MINOR_VERSION: ${{ github.event.inputs.minor_version }}
          PATCH_VERSION: ${{ github.event.inputs.patch_version }}
        run: |
          # Validate that version inputs contain only numeric values
          if ! [[ "$MAJOR_VERSION" =~ ^[0-9]+$ ]] || ! [[ "$MINOR_VERSION" =~ ^[0-9]+$ ]] || ! [[ "$PATCH_VERSION" =~ ^[0-9]+$ ]]; then
            echo "Error: Version inputs must contain only numeric values"
            exit 1
          fi
          echo "major=$MAJOR_VERSION" >> $GITHUB_OUTPUT
          echo "minor=$MINOR_VERSION" >> $GITHUB_OUTPUT
          echo "patch=$PATCH_VERSION" >> $GITHUB_OUTPUT

      - name: Create release branch
        env:
          MAJOR_VERSION: ${{ steps.validate-version.outputs.major }}
          MINOR_VERSION: ${{ steps.validate-version.outputs.minor }}
          PATCH_VERSION: ${{ steps.validate-version.outputs.patch }}
          RUN_NUMBER: ${{ github.run_number }}
        run: git checkout -b release/$MAJOR_VERSION.$MINOR_VERSION.$PATCH_VERSION.$RUN_NUMBER

      - name: Update Version Number
        uses: Afterlife-Guide/SemVer.Action@9dc4921011b4c29d63259b6bbd6d7322410e2e91
        with:
          path: semver.json
          major-version: ${{ steps.validate-version.outputs.major }}
          minor-version: ${{ steps.validate-version.outputs.minor }}
          patch-version: ${{ steps.validate-version.outputs.patch }}
          build-version: ${{ github.run_number }}

      - name: Update changelog
        uses: baynezy/ChangeLogger.Action@f714b7a6bcb0610dedb551cdc16a5adc0a775972
        with:
          tag: ${{ steps.validate-version.outputs.major }}.${{ steps.validate-version.outputs.minor }}.${{ steps.validate-version.outputs.patch }}.${{ github.run_number }}

      - name: Update docker image tag version in action.yml
        env:
          MAJOR_VERSION: ${{ steps.validate-version.outputs.major }}
          MINOR_VERSION: ${{ steps.validate-version.outputs.minor }}
          PATCH_VERSION: ${{ steps.validate-version.outputs.patch }}
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          sed -i "s/image: 'docker:\/\/ghcr.io\/afterlife-guide\/appsettings.merge:.*/image: 'docker:\/\/ghcr.io\/afterlife-guide\/appsettings.merge:$MAJOR_VERSION.$MINOR_VERSION.$PATCH_VERSION.$RUN_NUMBER'/" action.yml

      - name: Commit changelog, manifest and action definition files
        id: make-commit
        env:
          MAJOR_VERSION: ${{ steps.validate-version.outputs.major }}
          MINOR_VERSION: ${{ steps.validate-version.outputs.minor }}
          PATCH_VERSION: ${{ steps.validate-version.outputs.patch }}
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "no-reply@after-life.co"
          git add CHANGELOG.md semver.json action.yml
          git commit --message "Prepare release $MAJOR_VERSION.$MINOR_VERSION.$PATCH_VERSION.$RUN_NUMBER"

          echo "commit=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Push new branch
        env:
          MAJOR_VERSION: ${{ steps.validate-version.outputs.major }}
          MINOR_VERSION: ${{ steps.validate-version.outputs.minor }}
          PATCH_VERSION: ${{ steps.validate-version.outputs.patch }}
          RUN_NUMBER: ${{ github.run_number }}
        run: git push origin release/$MAJOR_VERSION.$MINOR_VERSION.$PATCH_VERSION.$RUN_NUMBER

      - name: Create pull request
        env:
          GH_TOKEN: ${{ secrets.CREATE_PR_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          COMMIT_SHA: ${{ steps.make-commit.outputs.commit }}
          MAJOR_VERSION: ${{ steps.validate-version.outputs.major }}
          MINOR_VERSION: ${{ steps.validate-version.outputs.minor }}
          PATCH_VERSION: ${{ steps.validate-version.outputs.patch }}
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          echo -e "Hi @$GITHUB_ACTOR!\n\nThis PR was created in response to a manual trigger of the release workflow here: https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID.\nI've updated the changelog and bumped the versions in the manifest files in this commit: $COMMIT_SHA.\n\nMerging this PR will create a GitHub release and upload any assets that are created as part of the release build." > msg.txt
          
          export msg=$(cat msg.txt) ; gh pr create \
          --head release/$MAJOR_VERSION.$MINOR_VERSION.$PATCH_VERSION.$RUN_NUMBER \
          --base master \
          --title "Release version $MAJOR_VERSION.$MINOR_VERSION.$PATCH_VERSION.$RUN_NUMBER" \
          --reviewer $GITHUB_ACTOR \
          --body "$msg"
